<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端App与后端交互业务流程（详细版）</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        h1, h2, h3 {
            color: #007bff;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .step {
            cursor: pointer;
            padding: 10px;
            margin: 5px 0;
            background-color: #e9ecef;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .step:hover {
            background-color: #d6d8db;
        }
        .details {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        #flowchart {
            text-align: center;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .module {
            background-color: #fff3cd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>前端App与后端交互业务流程（详细版）</h1>
    <p>基于您的描述，重新梳理了详细业务流程，强调网关分发、数据校验、缓存策略、分库分表、冷热数据分离、备份等。整体设计高度解耦、高度内聚，模块化架构。</p>

    <div id="flowchart" class="section">
        <h2>整体架构与流程图</h2>
        <div class="mermaid">
            graph TD
                A[前端App/Web] --> B{连接类型}
                B -->|HTTP| C[Nginx网关]
                B -->|WebSocket| C
                C --> D[分发到后端服务]
                D --> E[用户中台模块: 认证校验]
                E --> F[业务模块: 操作处理]
                F --> G{读/写操作}
                G -->|读| H[Redis查询]
                H -->|命中| I[返回数据]
                H -->|未命中| J[数据库查询]
                J --> K[更新Redis]
                K --> I
                G -->|写| L[Redis检查]
                L -->|有数据| M[更新Redis & 事务更新DB]
                L -->|无数据| N[查询DB & 事务更新DB & 更新Redis]
                M --> O[定时刷新Redis-DB]
                N --> O
                O --> P[分库分表处理]
                P --> Q{数据类型}
                Q -->|热数据| R[独立热数据服务器]
                Q -->|冷数据| S[集合冷数据服务器]
                S --> T[冷数据备份: 一个月前数据到备份DB]
                T --> U[可查询冷DB]
                R --> V[事务保护]
                S --> V
        </div>
    </div>

    <button onclick="toggleAllDetails()">展开/折叠所有详情</button>

    <div class="section">
        <h2>1. 前端发送环节</h2>
        <div class="step" onclick="toggleDetails('frontend')">点击查看详情</div>
        <div id="frontend" class="details">
            <p><strong>连接类型区分：</strong></p>
            <ul>
                <li><strong>普通网络连接（HTTP）：</strong>用于标准请求/响应，如GET/POST。</li>
                <li><strong>WebSocket连接：</strong>用于实时双向通信，如聊天、推送。</li>
            </ul>
            <p><strong>网关分发：</strong>Nginx作为网关，负责负载均衡、路由分发到后端服务。</p>
        </div>
    </div>

    <div class="section">
        <h2>2. 后端接收与校验环节</h2>
        <div class="step" onclick="toggleDetails('validation')">点击查看详情</div>
        <div id="validation" class="details">
            <p><strong>数据校验：</strong></p>
            <ul>
                <li>ID匹配：验证请求中的用户ID。</li>
                <li>Token匹配：JWT/OAuth验证用户身份。</li>
            </ul>
            <p><strong>用户确定：</strong>通过校验确定用户上下文，路由到相应业务模块。</p>
        </div>
    </div>

    <div class="section">
        <h2>3. 业务处理环节（读写操作）</h2>
        <div class="step" onclick="toggleDetails('business')">点击查看详情</div>
        <div id="business" class="details">
            <p><strong>读操作：</strong></p>
            <ol>
                <li>优先查询Redis缓存。</li>
                <li>未命中则查询数据库。</li>
                <li>查询后立即更新Redis（事务性）。</li>
            </ol>
            <p><strong>写操作：</strong></p>
            <ol>
                <li>检查Redis是否有数据。</li>
                <li>有：更新Redis和数据库（事务）。</li>
                <li>无：查询数据库，更新数据库和Redis（事务）。</li>
            </ol>
            <p><strong>Redis-DB同步：</strong>定时刷新机制，确保一致性。</p>
        </div>
    </div>

    <div class="section">
        <h2>4. 数据库架构与优化</h2>
        <div class="step" onclick="toggleDetails('database')">点击查看详情</div>
        <div id="database" class="details">
            <p><strong>分库分表：</strong>根据业务拆分数据库和表，降低单库压力。</p>
            <p><strong>热数据分离：</strong></p>
            <ul>
                <li>频繁查询热数据：抽取到独立服务器。</li>
                <li>不频繁冷数据：放到集合服务器。</li>
            </ul>
            <p><strong>事务保护：</strong>确保读写一致性，避免并发问题。</p>
            <p><strong>冷热数据备份：</strong>一个月前数据备份到冷数据库，支持查询但性能较低。</p>
        </div>
    </div>

    <div class="section">
        <h2>5. 模块化设计（高度解耦、内聚）</h2>
        <div class="step" onclick="toggleDetails('modules')">点击查看详情</div>
        <div id="modules" class="details">
            <div class="module"><strong>用户中台模块：</strong>负责认证、用户管理、权限控制。</div>
            <div class="module"><strong>缓存模块：</strong>Redis操作、定时刷新逻辑。</div>
            <div class="module"><strong>数据库模块：</strong>ORM、分库分表、事务管理。</div>
            <div class="module"><strong>业务模块：</strong>具体业务逻辑，如订单、查询等。</div>
            <div class="module"><strong>网关模块：</strong>Nginx配置、路由分发。</div>
            <div class="module"><strong>备份模块：</strong>冷数据迁移、备份策略。</div>
            <p>每个模块独立部署，支持微服务架构。</p>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true });

        function toggleDetails(id) {
            const element = document.getElementById(id);
            element.style.display = element.style.display === 'block' ? 'none' : 'block';
        }

        function toggleAllDetails() {
            const details = document.querySelectorAll('.details');
            details.forEach(detail => {
                detail.style.display = detail.style.display === 'block' ? 'none' : 'block';
            });
        }
    </script>
</body>
</html>